
# Build a docker image with Gitlab CI
# https://medium.com/faun/building-a-docker-image-with-gitlab-ci-and-net-core-8f59681a86c4

image: docker:stable

services:
  - docker:dind

variables:
 # Use TLS https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#tls-enabled
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:latest-$CI_COMMIT_REF_SLUG
  GIT_STRATEGY: fetch # This cannot be "none" due to the required Dockerfile
  GIT_DEPTH: "3"

img_builder:

 stage: img

 tags:
   - docker

 before_script: # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#using-the-gitlab-container-registry
 #  - docker info
   - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

 script:
 #   - echo "CI_REGISTRY is $CI_REGISTRY"
 #   - echo "CI_REGISTRY_IMAGE is $CI_REGISTRY_IMAGE"
   - docker build -t $IMAGE_TAG .
   - docker push $IMAGE_TAG

 rules:
   - if: '$CI_PIPELINE_SOURCE == "web" && $GITLAB_USER_NAME == "TW3" && $CI_COMMIT_REF_NAME == "staging"'
     when: always
     allow_failure: false

 after_script:
   - docker logout ${CI_REGISTRY}
